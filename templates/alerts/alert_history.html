{% extends "base.html" %}

{% block title %}Alert History - Firewall Report Center{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white mb-2">Alert History</h1>
            <p class="text-gray-400">View all triggered alerts</p>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="bg-slate-800 border border-slate-700 rounded-xl p-4">
        <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Alert Rule</label>
                <select name="rule" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white">
                    <option value="">All Rules</option>
                    {% for rule in rules %}
                    <option value="{{ rule.id }}" {% if request.GET.rule == rule.id|stringformat:"s" %}selected{% endif %}>
                        {{ rule.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Severity</label>
                <select name="severity" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white">
                    <option value="">All Severities</option>
                    <option value="critical" {% if request.GET.severity == 'critical' %}selected{% endif %}>Critical</option>
                    <option value="high" {% if request.GET.severity == 'high' %}selected{% endif %}>High</option>
                    <option value="medium" {% if request.GET.severity == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="low" {% if request.GET.severity == 'low' %}selected{% endif %}>Low</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Status</label>
                <select name="acknowledged" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white">
                    <option value="">All</option>
                    <option value="no" {% if request.GET.acknowledged == 'no' %}selected{% endif %}>Unacknowledged</option>
                    <option value="yes" {% if request.GET.acknowledged == 'yes' %}selected{% endif %}>Acknowledged</option>
                </select>
            </div>
            
            <div class="flex items-end">
                <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Filter
                </button>
            </div>
        </form>
    </div>
    
    <!-- Alert History List -->
    <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-700">
            <h3 class="text-lg font-semibold text-white">
                Alerts ({{ page_obj.paginator.count }} total)
            </h3>
        </div>
        
        <div class="divide-y divide-slate-700">
            {% for alert in page_obj %}
            <div class="px-6 py-4 hover:bg-slate-700/30 transition-colors">
                <div class="flex items-start justify-between">
                    <div class="flex items-start space-x-4 flex-1">
                        <!-- Severity Icon -->
                        <div class="w-12 h-12 rounded-lg flex items-center justify-center flex-shrink-0
                                    {% if alert.severity == 'critical' %}bg-red-500/20{% elif alert.severity == 'high' %}bg-orange-500/20{% elif alert.severity == 'medium' %}bg-yellow-500/20{% else %}bg-blue-500/20{% endif %}">
                            <i data-lucide="alert-triangle" 
                               class="w-6 h-6 {% if alert.severity == 'critical' %}text-red-400{% elif alert.severity == 'high' %}text-orange-400{% elif alert.severity == 'medium' %}text-yellow-400{% else %}text-blue-400{% endif %}"></i>
                        </div>
                        
                        <!-- Alert Details -->
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <h4 class="text-base font-semibold text-white">{{ alert.alert_rule.name }}</h4>
                                <span class="px-2 py-1 {% if alert.severity == 'critical' %}bg-red-500/20 text-red-400{% elif alert.severity == 'high' %}bg-orange-500/20 text-orange-400{% elif alert.severity == 'medium' %}bg-yellow-500/20 text-yellow-400{% else %}bg-blue-500/20 text-blue-400{% endif %} rounded text-xs font-semibold">
                                    {{ alert.severity|upper }}
                                </span>
                                {% if alert.acknowledged %}
                                <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs font-semibold">
                                    <i data-lucide="check" class="w-3 h-3 inline"></i>
                                    Acknowledged
                                </span>
                                {% endif %}
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-3">
                                <div>
                                    <p class="text-xs text-gray-500">Events</p>
                                    <p class="text-sm font-semibold text-white">{{ alert.event_count }}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Organization</p>
                                    <p class="text-sm font-semibold text-white">{{ alert.organization.name }}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Triggered</p>
                                    <p class="text-sm font-semibold text-white">{{ alert.triggered_at|date:"Y-m-d H:i" }}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">Notifications</p>
                                    <p class="text-sm font-semibold text-white">{{ alert.notifications_sent|length }} sent</p>
                                </div>
                            </div>
                            
                            <!-- Alert Details -->
                            {% if alert.details %}
                            <div class="bg-slate-700/50 rounded-lg p-3 space-y-2">
                                {% if alert.details.top_ips %}
                                <div>
                                    <p class="text-xs text-gray-400 mb-1">Top IPs:</p>
                                    <div class="flex flex-wrap gap-2">
                                        {% for item in alert.details.top_ips %}
                                        <span class="px-2 py-1 bg-slate-600 text-gray-300 rounded text-xs font-mono">
                                            {{ item.0 }} ({{ item.1 }})
                                        </span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if alert.details.top_countries %}
                                <div>
                                    <p class="text-xs text-gray-400 mb-1">Top Countries:</p>
                                    <div class="flex flex-wrap gap-2">
                                        {% for item in alert.details.top_countries %}
                                        <span class="px-2 py-1 bg-slate-600 text-gray-300 rounded text-xs">
                                            {{ item.0 }} ({{ item.1 }})
                                        </span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    {% if not alert.acknowledged %}
                    <form method="post" action="{% url 'alerts:acknowledge_alert' alert.id %}" class="ml-4">
                        {% csrf_token %}
                        <button type="submit" 
                                class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                            <i data-lucide="check" class="w-4 h-4 inline mr-1"></i>
                            Acknowledge
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="px-6 py-12 text-center">
                <div class="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="inbox" class="w-8 h-8 text-gray-500"></i>
                </div>
                <p class="text-gray-400">No alerts found</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="px-6 py-4 border-t border-slate-700 flex items-center justify-between">
            <div class="text-sm text-gray-400">
                Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }}
            </div>
            <div class="flex space-x-2">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}" 
                   class="px-3 py-2 bg-slate-700 text-white rounded hover:bg-slate-600 transition-colors">
                    Previous
                </a>
                {% endif %}
                
                <span class="px-3 py-2 bg-blue-600 text-white rounded">
                    {{ page_obj.number }}
                </span>
                
                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}" 
                   class="px-3 py-2 bg-slate-700 text-white rounded hover:bg-slate-600 transition-colors">
                    Next
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
