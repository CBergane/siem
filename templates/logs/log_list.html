{% extends "base.html" %}

{% block title %}Security Logs - Firewall Report Center{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between animate-slide-in">
        <div>
            <h1 class="text-3xl font-bold text-white mb-2">Security Logs</h1>
            <p class="text-gray-400">
                Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ total_count }} logs
            </p>
        </div>
        <div class="flex items-center space-x-3">
            <button onclick="clearFilters()"
                    class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                Clear Filters
            </button>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 animate-slide-in anim-delay-100">
        <form method="get" action="{% url 'logs:list' %}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- Date From -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">From Date</label>
                <input type="date" name="date_from" value="{{ current_filters.date_from }}"
                       class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <!-- Date To -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">To Date</label>
                <input type="date" name="date_to" value="{{ current_filters.date_to }}"
                       class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <!-- Source -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Source</label>
                <select name="source"
                        class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Sources</option>
                    {% for source in sources %}
                    <option value="{{ source }}" {% if current_filters.source == source %}selected{% endif %}>
                        {{ source|title }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Server (NEW!) -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">
                    <i data-lucide="server" class="w-3 h-3 inline"></i> Server
                </label>
                <select name="server"
                        class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Servers</option>
                    {% for server in servers %}
                    <option value="{{ server }}" {% if current_filters.server == server %}selected{% endif %}>
                        {{ server }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Action -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Action</label>
                <select name="action"
                        class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Actions</option>
                    {% for action in actions %}
                    <option value="{{ action }}" {% if current_filters.action == action %}selected{% endif %}>
                        {{ action|title }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Severity -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Severity</label>
                <select name="severity"
                        class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Severities</option>
                    {% for severity in severities %}
                    <option value="{{ severity }}" {% if current_filters.severity == severity %}selected{% endif %}>
                        {{ severity|title }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- IP Search -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">IP Address</label>
                <input type="text" name="ip" value="{{ current_filters.ip }}" placeholder="192.168.1.100"
                       class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <!-- Submit Button -->
            <div class="flex items-end">
                <button type="submit"
                        class="w-full px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center justify-center space-x-2">
                    <i data-lucide="filter" class="w-4 h-4"></i>
                    <span>Apply</span>
                </button>
            </div>
        </form>
    </div>
    
    <!-- Logs Table -->
    <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden animate-slide-in anim-delay-200">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-slate-900/50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Time</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Source IP</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Server</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Source</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Action</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Severity</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Path/Reason</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-700">
                    {% for log in page_obj %}
                    <tr class="hover:bg-slate-700/50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                            {{ log.timestamp|date:"Y-m-d H:i:s" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center space-x-2">
                                <span class="font-mono text-sm text-gray-200">{{ log.src_ip }}</span>
                                {% if log.geo_enriched %}
                                <span class="text-lg flag-slot" data-cc="{{ log.country_code }}" title="{{ log.country_name }}"></span>
                                {% endif %}
                            </div>
                            {% if log.city %}
                            <div class="text-xs text-gray-500">{{ log.city }}, {{ log.country_name }}</div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if log.source_host and log.source_host != 'unknown' %}
                            <span class="px-2 py-1 bg-slate-600/50 border border-slate-500 rounded text-gray-300 text-xs">
                                <i data-lucide="server" class="w-3 h-3 inline"></i>
                                {{ log.source_host }}
                            </span>
                            {% else %}
                            <span class="text-gray-500 text-xs">-</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if log.source_type == 'haproxy' %}
                            <span class="px-2 py-1 bg-blue-500/20 text-blue-400 rounded text-xs font-semibold">HAProxy</span>
                            {% elif log.source_type == 'nginx' %}
                            <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs font-semibold">Nginx</span>
                            {% elif log.source_type == 'crowdsec' %}
                            <span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs font-semibold">CrowdSec</span>
                            {% elif log.source_type == 'fail2ban' %}
                            <span class="px-2 py-1 bg-orange-500/20 text-orange-400 rounded text-xs font-semibold">Fail2ban</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if log.action == 'allow' %}
                            <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs font-semibold">
                                <i data-lucide="check" class="w-3 h-3 inline"></i> Allow
                            </span>
                            {% elif log.action == 'deny' %}
                            <span class="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs font-semibold">
                                <i data-lucide="x" class="w-3 h-3 inline"></i> Deny
                            </span>
                            {% elif log.action == 'ban' %}
                            <span class="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs font-semibold">
                                <i data-lucide="shield-off" class="w-3 h-3 inline"></i> Ban
                            </span>
                            {% elif log.action == 'rate_limit' %}
                            <span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded text-xs font-semibold">
                                <i data-lucide="zap" class="w-3 h-3 inline"></i> Rate Limit
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if log.severity == 'critical' %}
                            <span class="px-2 py-1 bg-red-600/20 text-red-300 rounded text-xs font-semibold">Critical</span>
                            {% elif log.severity == 'high' %}
                            <span class="px-2 py-1 bg-orange-500/20 text-orange-300 rounded text-xs font-semibold">High</span>
                            {% elif log.severity == 'medium' %}
                            <span class="px-2 py-1 bg-yellow-500/20 text-yellow-300 rounded text-xs font-semibold">Medium</span>
                            {% else %}
                            <span class="px-2 py-1 bg-blue-500/20 text-blue-300 rounded text-xs font-semibold">Low</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-400 max-w-xs truncate">
                            {% if log.path %}{{ log.path }}{% else %}{{ log.reason|default:"-" }}{% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center">
                                <i data-lucide="inbox" class="w-12 h-12 text-gray-500 mb-2"></i>
                                <p class="text-gray-400">No logs found</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="bg-slate-900/30 px-6 py-4 flex items-center justify-between border-t border-slate-700">
            <div class="text-sm text-gray-400">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </div>
            <div class="flex space-x-2">
                {% if page_obj.has_previous %}
                <a href="?page=1{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                   class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-gray-300 rounded transition-colors">
                    First
                </a>
                <a href="?page={{ page_obj.previous_page_number }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                   class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-gray-300 rounded transition-colors">
                    Previous
                </a>
                {% endif %}
                
                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                   class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-gray-300 rounded transition-colors">
                    Next
                </a>
                <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                   class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-gray-300 rounded transition-colors">
                    Last
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function clearFilters() {
        window.location.href = '{% url "logs:list" %}';
    }
</script>
{% endblock %}
